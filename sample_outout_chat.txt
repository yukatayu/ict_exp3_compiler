ORG 0 / Interrupt Entry Point
INT_RET, HEX 0 / Interrupt Return Address
BUN INT_MAIN
ORG 10 / Entry Point
LDA MASKSIN
ADD MASKPIN
ADD MASKPOUT
IMK
SIO
ION

 / > while loop MainLoop
_XWH1MainLoop,
 / while (
    LDA HaltFlag
SZA
BUN _XWH3MainLoop
BUN _XWH2MainLoop
 / ) {
_XWH2MainLoop,
BUN _XWH1MainLoop
 / }
_XWH3MainLoop,
 / < end of while loop MainLoop

_M_, HLT

 / > beginning of INT_MAIN
INT_MAIN,
    STA ACCBAK
    CLA
    CIL
    STA EBAK

     / > if InputAvailable
     / if (
        CLA
        INC
        SKI
        CLA
    SZA
    BUN _XIF1InputAvailable
    BUN _XIF2InputAvailable
     / ) {
    _XIF1InputAvailable,
        INP
        STA INTMP

             / > if CheckCharCtrlD
             / if (
                LDA ASCIICTRLD
                CMA
                INC
                ADD INTMP
            SZA
            BUN _XIF2CheckCharCtrlD
            BUN _XIF1CheckCharCtrlD
             / ) {
            _XIF1CheckCharCtrlD,
                CLA
                INC
                STA HaltFlag
            BUN _XIF3CheckCharCtrlD
             / } else {  // CheckCharCtrlD
            _XIF2CheckCharCtrlD,
                LDA INTMP
                STA SENDBUFPTR I
                LDA SENDBUFPTR
                INC
                STA SENDBUFPTR
             / }
            _XIF3CheckCharCtrlD,
             / < end of if CheckCharCtrlD

            CLA
            INC
            STA OUTTRIG
     / }
    _XIF2InputAvailable,
     / < end of if InputAvailable


     / > beginning of Prepare
    Prepare,

         / > if OutTrigger
         / if (
            LDA OUTTRIG
        SZA
        BUN _XIF1OutTrigger
        BUN _XIF2OutTrigger
         / ) {
        _XIF1OutTrigger,
            CLA
            STA OUTTRIG

             / > beginning of RenderText
            RenderText,
                LDA DISPBUFPTRINIT
                STA DISPBUFPTR

                LDA ClearLinePtrInit
                STA TEMP1
                _XFOR1_XAUTO1,
                 / for (
                    LDA TEMP1 I
                SZA
                BUN _XFOR2_XAUTO1
                BUN _XFOR3_XAUTO1
                 / ) {
                _XFOR2_XAUTO1,
                    LDA TEMP1 I
                    STA DISPBUFPTR I
                    LDA DISPBUFPTR
                    INC
                    STA DISPBUFPTR
                LDA TEMP1
                INC
                STA TEMP1
                BUN _XFOR1_XAUTO1
                 / }
                _XFOR3_XAUTO1,


                 / if (
                    LDA STATUREAD
                SZA
                BUN _XIF1_XAUTO2
                BUN _XIF2_XAUTO2
                 / ) {
                _XIF1_XAUTO2,
                    LDA RedBackPtrInit
                    STA STATUSCOLOR
                BUN _XIF3_XAUTO2
                 / } else {  // 
                _XIF2_XAUTO2,
                    LDA ResetTextPtrInit
                    STA STATUSCOLOR
                 / }
                _XIF3_XAUTO2,


                LDA STATUSCOLOR
                STA TEMP1
                _XFOR1_XAUTO3,
                 / for (
                    LDA TEMP1 I
                SZA
                BUN _XFOR2_XAUTO3
                BUN _XFOR3_XAUTO3
                 / ) {
                _XFOR2_XAUTO3,
                    LDA TEMP1 I
                    STA DISPBUFPTR I
                    LDA DISPBUFPTR
                    INC
                    STA DISPBUFPTR
                LDA TEMP1
                INC
                STA TEMP1
                BUN _XFOR1_XAUTO3
                 / }
                _XFOR3_XAUTO3,

                LDA ASCIISPACE
                STA DISPBUFPTR I
                LDA DISPBUFPTR
                INC
                STA DISPBUFPTR
                LDA ASCIISPACE
                STA DISPBUFPTR I
                LDA DISPBUFPTR
                INC
                STA DISPBUFPTR

                LDA ResetTextPtrInit
                STA TEMP1
                _XFOR1_XAUTO4,
                 / for (
                    LDA TEMP1 I
                SZA
                BUN _XFOR2_XAUTO4
                BUN _XFOR3_XAUTO4
                 / ) {
                _XFOR2_XAUTO4,
                    LDA TEMP1 I
                    STA DISPBUFPTR I
                    LDA DISPBUFPTR
                    INC
                    STA DISPBUFPTR
                LDA TEMP1
                INC
                STA TEMP1
                BUN _XFOR1_XAUTO4
                 / }
                _XFOR3_XAUTO4,


                LDA GreenTextPtrInit
                STA TEMP1
                _XFOR1_XAUTO5,
                 / for (
                    LDA TEMP1 I
                SZA
                BUN _XFOR2_XAUTO5
                BUN _XFOR3_XAUTO5
                 / ) {
                _XFOR2_XAUTO5,
                    LDA TEMP1 I
                    STA DISPBUFPTR I
                    LDA DISPBUFPTR
                    INC
                    STA DISPBUFPTR
                LDA TEMP1
                INC
                STA TEMP1
                BUN _XFOR1_XAUTO5
                 / }
                _XFOR3_XAUTO5,

                LDA ASCIISPACE
                STA DISPBUFPTR I
                LDA DISPBUFPTR
                INC
                STA DISPBUFPTR

                LDA ResetTextPtrInit
                STA TEMP1
                _XFOR1_XAUTO6,
                 / for (
                    LDA TEMP1 I
                SZA
                BUN _XFOR2_XAUTO6
                BUN _XFOR3_XAUTO6
                 / ) {
                _XFOR2_XAUTO6,
                    LDA TEMP1 I
                    STA DISPBUFPTR I
                    LDA DISPBUFPTR
                    INC
                    STA DISPBUFPTR
                LDA TEMP1
                INC
                STA TEMP1
                BUN _XFOR1_XAUTO6
                 / }
                _XFOR3_XAUTO6,


                LDA PromptTextPtrInit
                STA TEMP1
                _XFOR1_XAUTO7,
                 / for (
                    LDA TEMP1 I
                SZA
                BUN _XFOR2_XAUTO7
                BUN _XFOR3_XAUTO7
                 / ) {
                _XFOR2_XAUTO7,
                    LDA TEMP1 I
                    STA DISPBUFPTR I
                    LDA DISPBUFPTR
                    INC
                    STA DISPBUFPTR
                LDA TEMP1
                INC
                STA TEMP1
                BUN _XFOR1_XAUTO7
                 / }
                _XFOR3_XAUTO7,


                LDA SENDBUFPTRINIT
                STA TEMP1
                _XFOR1_XAUTO8,
                 / for (
                    LDA TEMP1 I
                SZA
                BUN _XFOR2_XAUTO8
                BUN _XFOR3_XAUTO8
                 / ) {
                _XFOR2_XAUTO8,
                    LDA TEMP1 I
                    STA DISPBUFPTR I
                    LDA DISPBUFPTR
                    INC
                    STA DISPBUFPTR
                LDA TEMP1
                INC
                STA TEMP1
                BUN _XFOR1_XAUTO8
                 / }
                _XFOR3_XAUTO8,

                CLA
                STA DISPBUFPTR I
                LDA DISPBUFPTRINIT
                STA DISPBUFPTR
             / < end of RenderText

            ADD MASKSOUT
            ADD MASKPIN
            ADD MASKPOUT
            IMK
            CLA
            INC
            STA ISSTATOUT
         / }
        _XIF2OutTrigger,
         / < end of if OutTrigger


         / > if InTrigger
         / if (
            LDA INPTRIG
        SZA
        BUN _XIF1InTrigger
        BUN _XIF2InTrigger
         / ) {
        _XIF1InTrigger,
            CLA
            STA INPTRIG
            LDA MASKSIN
            ADD MASKPIN
            ADD MASKPOUT
            IMK
            CLA
            STA ISSTATOUT
         / }
        _XIF2InTrigger,
         / < end of if InTrigger

     / < end of Prepare


     / > if OutputAvailable
     / if (
        CLA
        INC
        SKO
        CLA
    SZA
    BUN _XIF1OutputAvailable
    BUN _XIF2OutputAvailable
     / ) {
    _XIF1OutputAvailable,

         / > if ShowMain
         / if (

             / > beginning of GetOutput
            GetOutput,
                LDA DISPBUFPTR I
                STA TEMP1

                 / > if StepDispText
                 / if (
                    LDA TEMP1
                SZA
                BUN _XIF1StepDispText
                BUN _XIF2StepDispText
                 / ) {
                _XIF1StepDispText,
                    LDA DISPBUFPTR
                    INC
                    STA DISPBUFPTR
                BUN _XIF3StepDispText
                 / } else {  // StepDispText
                _XIF2StepDispText,

                     / if (
                        LDA ISSTATOUT
                    SZA
                    BUN _XIF1_XAUTO9
                    BUN _XIF2_XAUTO9
                     / ) {
                    _XIF1_XAUTO9,
                        CLA
                        INC
                        STA INPTRIG
                     / }
                    _XIF2_XAUTO9,

                 / }
                _XIF3StepDispText,
                 / < end of if StepDispText

                LDA TEMP1
             / < end of GetOutput

        SZA
        BUN _XIF1ShowMain
        BUN _XIF2ShowMain
         / ) {
        _XIF1ShowMain,
            OUT
         / }
        _XIF2ShowMain,
         / < end of if ShowMain

     / }
    _XIF2OutputAvailable,
     / < end of if OutputAvailable

    InterruptReturn,

     / > if HaltTrigger
     / if (
        LDA HaltFlag
    SZA
    BUN _XIF1HaltTrigger
    BUN _XIF2HaltTrigger
     / ) {
    _XIF1HaltTrigger,
        LDA EBAK
        CLE
        CIR
        LDA ACCBAK
        BUN INT_RET I
     / }
    _XIF2HaltTrigger,
     / < end of if HaltTrigger

    LDA EBAK
    CLE
    CIR
    LDA ACCBAK
    ION
    BUN INT_RET I
 / < end of INT_MAIN

 / Data Segment
    ACCBAK, DEC 0
    EBAK, DEC 0
    INPTRIG, DEC 0
    OUTTRIG, DEC 0
    SEPTRIG, DEC 0
    HaltFlag, DEC 0
    REDRAWTRIG, DEC 0
    MASKSIN, DEC 8
    MASKSOUT, DEC 4
    MASKPIN, DEC 0
    MASKPOUT, DEC 0
    SENDBUFFER, DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
    SENDBUFPTRINIT, SYM SENDBUFFER
    SENDBUFPTR, SYM SENDBUFFER
    RECVBUFFER, DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
    RECVBUFPTRINIT, SYM RECVBUFFER
    RECVBUFPTR, SYM RECVBUFFER
    DISPBUFFER, DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
        DEC 0
    DISPBUFPTRINIT, SYM DISPBUFFER
    DISPBUFPTR, SYM DISPBUFFER
    ASCIIENTER, DEC 10
    ASCIISPACE, DEC 32
    ASCIICTRLD, DEC 4
    TEMP1, DEC 0
    TEMP2, DEC 0
    INTMP, DEC 0
    PromptText, DEC 32
        DEC 62
        DEC 32
        DEC 0
        DEC 0
    PromptTextPtrInit, SYM PromptText
    RedText, DEC 60
        DEC 82
        DEC 101
        DEC 100
        DEC 62
        DEC 0
        DEC 0
    RedTextPtrInit, SYM RedText
    RedBack, DEC 60
        DEC 82
        DEC 101
        DEC 100
        DEC 66
        DEC 97
        DEC 99
        DEC 107
        DEC 62
        DEC 0
        DEC 0
    RedBackPtrInit, SYM RedBack
    GreenText, DEC 60
        DEC 71
        DEC 114
        DEC 101
        DEC 101
        DEC 110
        DEC 62
        DEC 0
        DEC 0
    GreenTextPtrInit, SYM GreenText
    ResetText, DEC 60
        DEC 82
        DEC 101
        DEC 115
        DEC 101
        DEC 116
        DEC 62
        DEC 0
        DEC 0
    ResetTextPtrInit, SYM ResetText
    ClearLine, DEC 13
        DEC 10
        DEC 0
        DEC 0
    ClearLinePtrInit, SYM ClearLine
    ISSTATOUT, DEC 0
    STATUSCOLOR, SYM ResetText
    STATUREAD, DEC 0
    INPUTCHARNUM, DEC 0
END

